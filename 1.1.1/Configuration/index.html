<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Configuration - Native SQL Engine - 1.1.1</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Configuration";
    var mkdocs_page_input_path = "Configuration.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Native SQL Engine - 1.1.1</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../User-Guide/">User Guide</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../Prerequisite/">Prerequisite</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../Installation/">Installation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../InstallationNotes/">InstallationNotes</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Configuration</a>
    <ul class="current">
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../SparkInstallation/">SparkInstallation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../ApacheArrowInstallation/">ApacheArrowInstallation</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../OAP-Installation-Guide/">OAP Installation Guide</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../OAP-Developer-Guide/">OAP Developer Guide</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="" href="../../">Version Selector</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Native SQL Engine - 1.1.1</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Configuration</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="spark-configurations-for-native-sql-engine">Spark Configurations for Native SQL Engine</h1>
<p>There are many configuration could impact the Native SQL Engine performance and can be fine tune in Spark.
You can add these configuration into spark-defaults.conf to enable or disable the setting.</p>
<table>
<thead>
<tr>
<th>Parameters</th>
<th>Description</th>
<th>Recommend Setting</th>
</tr>
</thead>
<tbody>
<tr>
<td>spark.driver.extraClassPath</td>
<td>To add Arrow Data Source and Native SQL Engine jar file in Spark Driver</td>
<td>/path/to/jar_file1:/path/to/jar_file2</td>
</tr>
<tr>
<td>spark.executor.extraClassPath</td>
<td>To add Arrow Data Source and Native SQL Engine jar file in Spark Executor</td>
<td>/path/to/jar_file1:/path/to/jar_file2</td>
</tr>
<tr>
<td>spark.executorEnv.LIBARROW_DIR</td>
<td>To set up the location of Arrow library, by default it will search the loation of jar to be uncompressed</td>
<td>/path/to/arrow_library/</td>
</tr>
<tr>
<td>spark.executorEnv.CC</td>
<td>To set up the location of gcc</td>
<td>/path/to/gcc/</td>
</tr>
<tr>
<td>spark.executor.memory</td>
<td>To set up how much memory to be used for Spark Executor.</td>
<td></td>
</tr>
<tr>
<td>spark.memory.offHeap.size</td>
<td>To set up how much memory to be used for Java OffHeap.<br /> Please notice Native SQL Engine will leverage this setting to allocate memory space for native usage even offHeap is disabled. <br /> The value is based on your system and it is recommended to set it larger if you are facing Out of Memory issue in Native SQL Engine</td>
<td>30G</td>
</tr>
<tr>
<td>spark.executor.extraJavaOptions</td>
<td>To set up how much Direct Memory to be used for Native SQL Engine. The value is based on your system and it is recommended to set it larger if you are facing Out of Memory issue in Native SQL Engine</td>
<td>-XX:MaxDirectMemorySize=30G</td>
</tr>
<tr>
<td>spark.sql.sources.useV1SourceList</td>
<td>Choose to use V1 source</td>
<td>avro</td>
</tr>
<tr>
<td>spark.sql.join.preferSortMergeJoin</td>
<td>To turn off preferSortMergeJoin in Spark</td>
<td>false</td>
</tr>
<tr>
<td>spark.sql.extensions</td>
<td>To turn on Native SQL Engine Plugin</td>
<td>com.intel.oap.ColumnarPlugin</td>
</tr>
<tr>
<td>spark.shuffle.manager</td>
<td>To turn on Native SQL Engine Columnar Shuffle Plugin</td>
<td>org.apache.spark.shuffle.sort.ColumnarShuffleManager</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.batchscan</td>
<td>Enable or Disable Columnar Batchscan, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.hashagg</td>
<td>Enable or Disable Columnar Hash Aggregate, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.projfilter</td>
<td>Enable or Disable Columnar Project and Filter, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.codegen.sort</td>
<td>Enable or Disable Columnar Sort, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.window</td>
<td>Enable or Disable Columnar Window, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.shuffledhashjoin</td>
<td>Enable or Disable ShffuledHashJoin, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.sortmergejoin</td>
<td>Enable or Disable Columnar Sort Merge Join, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.union</td>
<td>Enable or Disable Columnar Union, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.expand</td>
<td>Enable or Disable Columnar Expand, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.broadcastexchange</td>
<td>Enable or Disable Columnar Broadcast Exchange, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.nanCheck</td>
<td>Enable or Disable Nan Check, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.hashCompare</td>
<td>Enable or Disable Hash Compare in HashJoins or HashAgg, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.broadcastJoin</td>
<td>Enable or Disable Columnar BradcastHashJoin, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.wholestagecodegen</td>
<td>Enable or Disable Columnar WholeStageCodeGen, default is true</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.preferColumnar</td>
<td>Enable or Disable Columnar Operators, default is false.<br /> This parameter could impact the performance in different case. In some cases, to set false can get some performance boost.</td>
<td>false</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.joinOptimizationLevel</td>
<td>Fallback to row operators if there are several continous joins</td>
<td>6</td>
</tr>
<tr>
<td>spark.sql.execution.arrow.maxRecordsPerBatch</td>
<td>Set up the Max Records per Batch</td>
<td>10000</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.wholestagecodegen.breakdownTime</td>
<td>Enable or Disable metrics in Columnar WholeStageCodeGen</td>
<td>false</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.tmp_dir</td>
<td>Set up a folder to store the codegen files</td>
<td>/tmp</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.shuffle.customizedCompression.codec</td>
<td>Set up the codec to be used for Columnar Shuffle, default is lz4</td>
<td>lz4</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.numaBinding</td>
<td>Set up NUMABinding, default is false</td>
<td>true</td>
</tr>
<tr>
<td>spark.oap.sql.columnar.coreRange</td>
<td>Set up the core range for NUMABinding, only works when numaBinding set to true. <br /> The setting is based on the number of cores in your system. Use 72 cores as an example.</td>
<td>0-17,36-53 &#124;18-35,54-71</td>
</tr>
</tbody>
</table>
<p>Below is an example for spark-default.conf, if you are using conda to install OAP project.</p>
<pre><code>##### Columnar Process Configuration

spark.sql.sources.useV1SourceList avro
spark.sql.join.preferSortMergeJoin false
spark.sql.extensions com.intel.oap.ColumnarPlugin
spark.shuffle.manager org.apache.spark.shuffle.sort.ColumnarShuffleManager

# note native sql engine depends on arrow data source
spark.driver.extraClassPath $HOME/miniconda2/envs/oapenv/oap_jars/spark-columnar-core-&lt;version&gt;-jar-with-dependencies.jar:$HOME/miniconda2/envs/oapenv/oap_jars/spark-arrow-datasource-standard-&lt;version&gt;-jar-with-dependencies.jar
spark.executor.extraClassPath $HOME/miniconda2/envs/oapenv/oap_jars/spark-columnar-core-&lt;version&gt;-jar-with-dependencies.jar:$HOME/miniconda2/envs/oapenv/oap_jars/spark-arrow-datasource-standard-&lt;version&gt;-jar-with-dependencies.jar

spark.executorEnv.LIBARROW_DIR      $HOME/miniconda2/envs/oapenv
spark.executorEnv.CC                $HOME/miniconda2/envs/oapenv/bin/gcc
######
</code></pre>

<p>Before you start spark, you must use below command to add some environment variables.</p>
<pre><code>export CC=$HOME/miniconda2/envs/oapenv/bin/gcc
export LIBARROW_DIR=$HOME/miniconda2/envs/oapenv/
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../SparkInstallation/" class="btn btn-neutral float-right" title="SparkInstallation">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../InstallationNotes/" class="btn btn-neutral" title="InstallationNotes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../InstallationNotes/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../SparkInstallation/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
